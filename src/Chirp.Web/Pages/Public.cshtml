@page "/"
@model Chirp.Web.Pages.PublicModel
@inject SignInManager<Author> SignInManager
@inject UserManager<Author> UserManager
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
    var NumberOfPages    = (Math.Ceiling((double) Model.TotalCheeps / Model.CheepsPerPage) - 1);
    var UserName         = @Model.UserName;
    var CheepOpinionInfo = @Model.CheepOpinionsInfo;
    var Cheeps           = @Model.Cheeps;
}

<div>
    @if(SignInManager.IsSignedIn(User))
    {
        <div class="post-cheep-wrapper">
            <div class="post-cheep-profilepicture profile-picture">
                <img src="/images/blank.png" alt="Profile Picture" />
                <strong>@UserName</strong>
            </div>
            <form method="post" asp-page-handler="Cheep">
                <input type="text" asp-for="CheepText" class="post-cheep-form-control form-control" aria-required="true" placeholder="Hey @UserName! What's on your mind?" />
                <span asp-validation-for="CheepText" class="text-danger"></span>
                <div class="post-cheep-button-wrapper">
                    <button type="submit" class="post-cheep-button btn">Cheep!</button>
                </div>
            </form>
        </div>
    } 
    else
    {
        <p class="post-cheep-text">Wanna Cheep? Click <a asp-area="Identity" asp-page="/Account/Login">here</a> to log in.</p>
    }

    <h2> Public Timeline </h2>
    <div id="orderByContainer">
        <partial name="./Partials/_OrderByPartial" />
    </div>


    @if (Cheeps.Any())
    {
        <div id="cheepsContainer">
            <partial name="./Partials/_PublicCheepPartial" model="Model" />
        </div>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }

    <div class="pagination">
        @for (int i = 1; i <= NumberOfPages; i++)
        {
            @if(i == NumberOfPages)
            {
                <a href="/?page=@(i)">@(i)</a>
            } 
            else
            {
                <a href="/?page=@(i)">@(i)</a>
            }
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const toggle = () => { document.querySelector('.dropdown-wrapper').classList.toggle('active'); };
        document.querySelector('.toggle').addEventListener("click", toggle);


        function orderCheeps(orderBy) {
            console.log('Ordering Cheeps by:', orderBy);

            var cheepContainer = $('#cheeps-container');

            $.ajax({
                url: '@Url.Page("/Public")?handler=OrderCheepsBy&orderBy=' + orderBy,
                method: 'GET',
                success: function (data) {
                    console.log('AJAX success! Received data:', data);
                    $('#cheeps-container').html(data);
                },
                error: function (xhr, status, error) {
                    alert('Failed to retrieve Cheeps');
                    $('#cheeps-container').html("[AJAX Error] Cheeps could not located");
                }
            });
        }
    </script>
}